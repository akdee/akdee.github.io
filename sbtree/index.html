<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Self Balancing Trees in Python</title>
	<link rel="stylesheet" href="../style/style.css" type="text/css">
	<script type="text/javascript" src="../style/style.js"></script>
</head>
<body>
<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Header ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div id="header"><a href="../index.html">Alec Dee's Homepage</a></div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Introduction ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Introduction</h1>
<p>Self balancing binary search trees are data structures that allow us to add, remove, and find data
all in logarithmic time. They improve upon traditional binary search trees, which cannot be modified
once created.</p>
<br>
<p>In this article we present an implementation of the self balancing <a href="https://en.wikipedia.org/wiki/AVL_tree">AVL tree</a> in python, and compare
its performance with other implementations.</p>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Implementation ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Implementation</h1>
<p>The full implementation can be downloaded here: <a href="./SBTree.py">SBTree.py</a></p>
<br>
<p>And this is an example of using the tree:</p>
<br>
<div class="codeblock langpython">from SBTree import SBTree
tree=SBTree(unique=False)
tree.add(6,"Friday")
tree.add(3,"Wednesday")
tree.add(1,"Monday")
tree.add(5,"REMOVE")
tree.add(2,"Tuesday")
tree.add(3,"Thursday")
tree.remove(5)
for n in tree:
	print(str(n.key)+": "+str(n.value))</div>
<br>
<p>Console output:</p>
<br>
<div class="consoleblock">1: Monday
2: Tuesday
3: Wednesday
3: Thursday
6: Friday</div>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Performance ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Performance</h1>
<p>Our performance data is generated from speedtest.py in <a href="./testing.zip">testing.zip</a> using the python2 runtime. Our
own timing is denoted by "dee", with timings from various other authors denoted by their screen
names. Source code and project links can also be found in <a href="./testing.zip">testing.zip</a>. In the case that an
implementation didn't have searching or deletion, its timings were omitted from those tests. girish3
has been omitted entirely due to it timing out when adding keys.</p>
<br>
<p>Total time taken to add <i>n</i> keys:</p>
<br>
<br>
<img src="add_graph.svg" style="width:100%" alt="node adding graph">
<br>
<br>
<br>
<p>We place slightly above average compared to other trees. msingh beats us by having a simpler
insertion loop with fewer rebalances due to it being a red-black tree. yoo beats us and msingh by
having the same rebalancing function as msingh and an even simpler insertion procedure.</p>
<br>
<p>Total time taken to remove <i>n</i> keys from a 100000 element tree:</p>
<br>
<br>
<img src="rem_graph.svg" style="width:100%" alt="node removal graph">
<br>
<br>
<br>
<p>Once again we place above average. msingh beats us by using a simpler search function to search for
the key being removed. This can also be seen in the search timings. It should be noted that many
implementations didn't include any way to remove keys.</p>
<br>
<p>Time to search for all keys in a 100000 node tree:</p>
<br>
<table class="datatable headerrow">
<tr><td>Name</td><td>Search Time</td></tr>
<tr><td>dee</td><td>0.876706 s</td></tr>
<tr><td>mozmanavl</td><td>0.297049 s</td></tr>
<tr><td>mozmanrb</td><td>0.296963 s</td></tr>
<tr><td>msingh</td><td>0.692859 s</td></tr>
<tr><td>pathak</td><td>N/A</td></tr>
<tr><td>pgrafov</td><td>0.546643 s</td></tr>
<tr><td>reid</td><td>1.343359 s</td></tr>
<tr><td>stanisl</td><td>1.327304 s</td></tr>
<tr><td>yoo</td><td>N/A</td></tr>
</table>
<br>
<p>We perform poorly in this test. This is primarily because we have a complicated search function that
can perform more than equality matching and can handle duplicate keys.</p>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Explanation ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Explanation</h1>
<p>Binary trees are trees who's nodes have exactly 2 child nodes, although either child may be null. We
will denote the 2 child nodes as "left" and "right". In addition, each node will have a parent and a
height, with height being defined as <i>max(left.height,right.height)+1</i>. In this way, the height of a
node is actually the distance to its most distant child. For the sake of completeness, we will
define null to have a height of -1. There is also one node that is not a child of any other node,
and that is the root node.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 234" class="diagram">
<g transform="translate(197,27)">
	<line x1="160" y1="0" x2="80" y2="60"/>
	<line x1="160" y1="0" x2="240" y2="60"/>
	<line x1="80" y1="60" x2="40" y2="120"/>
	<line x1="80" y1="60" x2="120" y2="120"/>
	<line x1="240" y1="60" x2="200" y2="120"/>
	<line x1="240" y1="60" x2="280" y2="120"/>
	<line x1="40" y1="120" x2="0" y2="180"/>
	<line x1="40" y1="120" x2="80" y2="180"/>
	<g class="bgfill highstroke">
		<circle cx="160" cy="0" r="17"/>
		<circle cx="80" cy="60" r="17"/>
		<circle cx="240" cy="60" r="17"/>
		<circle cx="40" cy="120" r="17"/>
		<circle cx="120" cy="120" r="17"/>
		<circle cx="200" cy="120" r="17"/>
		<circle cx="280" cy="120" r="17"/>
		<circle cx="0" cy="180" r="17"/>
		<circle cx="80" cy="180" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="160" y="0" dy="0.3em">A</text>
		<text x="80" y="60" dy="0.3em">B</text>
		<text x="240" y="60" dy="0.3em">C</text>
		<text x="40" y="120" dy="0.3em">D</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="120" y="120" dy="0.3em">NUL</text>
		<text x="200" y="120" dy="0.3em">NUL</text>
		<text x="280" y="120" dy="0.3em">NUL</text>
		<text x="0" y="180" dy="0.3em">NUL</text>
		<text x="80" y="180" dy="0.3em">NUL</text>
	</g>
</g>
<g transform="translate(540,44)">
	<rect x="0" y="0" width="280" height="140" stroke-width="1" fill="none"/>
	<line x1="0" y1="28" x2="280" y2="28" style="stroke-width:1;"/>
	<line x1="60" y1="0" x2="60" y2="140" style="stroke-width:1;"/>
	<line x1="140" y1="0" x2="140" y2="140" style="stroke-width:1;"/>
	<g text-anchor="middle">
		<text x="30" y="19">Node</text>
		<text x="30" y="49">A</text>
		<text x="30" y="69">B</text>
		<text x="30" y="89">C</text>
		<text x="30" y="109">D</text>
		<text x="30" y="129">NUL</text>
		<text x="100" y="19">Height</text>
		<text x="100" y="49">2</text>
		<text x="100" y="69">1</text>
		<text x="100" y="89">0</text>
		<text x="100" y="109">0</text>
		<text x="100" y="129">-1</text>
	</g>
	<g>
		<text x="155" y="19">Calculation</text>
		<text x="155" y="49">max( 1, 0)+1</text>
		<text x="155" y="69">max( 0,-1)+1</text>
		<text x="155" y="89">max(-1,-1)+1</text>
		<text x="155" y="109">max(-1,-1)+1</text>
	</g>
</g>
</svg>
<br>
<p>Binary *search* trees have the additional property that for a given node, any child to the left of
that node will satisfy <i>child.key&lt;=node.key</i>, and any child to the right will satisfy
<i>child.key&gt;=node.key</i>. Here, <i>key</i> is some value that the user will assign to the node that determines
how it will be sorted relative to other nodes. The tree below shows several nodes with different key
values that exemplify this property.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 234" class="diagram">
<g transform="translate(201,10)">
	<line x1="139" y1="79" x2="299" y2="19"/>
	<line x1="459" y1="79" x2="299" y2="19"/>
	<line x1="59" y1="139" x2="139" y2="79"/>
	<line x1="219" y1="139" x2="139" y2="79"/>
	<line x1="379" y1="139" x2="459" y2="79"/>
	<line x1="539" y1="139" x2="459" y2="79"/>
	<line x1="19" y1="199" x2="59" y2="139"/>
	<line x1="99" y1="199" x2="59" y2="139"/>
	<line x1="179" y1="199" x2="219" y2="139"/>
	<line x1="259" y1="199" x2="219" y2="139"/>
	<line x1="339" y1="199" x2="379" y2="139"/>
	<line x1="419" y1="199" x2="379" y2="139"/>
	<line x1="499" y1="199" x2="539" y2="139"/>
	<line x1="579" y1="199" x2="539" y2="139"/>
	<g class="bgfill highstroke">
		<circle cx="299" cy="19" r="17"/>
		<circle cx="139" cy="79" r="17"/>
		<circle cx="459" cy="79" r="17"/>
		<circle cx="59" cy="139" r="17"/>
		<circle cx="219" cy="139" r="17"/>
		<circle cx="379" cy="139" r="17"/>
		<circle cx="539" cy="139" r="17"/>
		<circle cx="19" cy="199" r="17"/>
		<circle cx="99" cy="199" r="17"/>
		<circle cx="179" cy="199" r="17"/>
		<circle cx="259" cy="199" r="17"/>
		<circle cx="339" cy="199" r="17"/>
		<circle cx="419" cy="199" r="17"/>
		<circle cx="499" cy="199" r="17"/>
		<circle cx="579" cy="199" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="299" y="20" dy="0.3em">7</text>
		<text x="139" y="80" dy="0.3em">3</text>
		<text x="459" y="80" dy="0.3em">11</text>
		<text x="59" y="140" dy="0.3em">1</text>
		<text x="219" y="140" dy="0.3em">5</text>
		<text x="379" y="140" dy="0.3em">9</text>
		<text x="539" y="140" dy="0.3em">13</text>
		<text x="19" y="200" dy="0.3em">0</text>
		<text x="99" y="200" dy="0.3em">2</text>
		<text x="179" y="200" dy="0.3em">4</text>
		<text x="259" y="200" dy="0.3em">6</text>
		<text x="339" y="200" dy="0.3em">8</text>
		<text x="419" y="200" dy="0.3em">10</text>
		<text x="499" y="200" dy="0.3em">12</text>
		<text x="579" y="200" dy="0.3em">14</text>
	</g>
	<g transform="translate(341,13) rotate(20.55) scale(0.8)">
		<text x="0" y="0" class="highfill">greater than</text>
		<text x="0" y="1.2em" class="highfill">or equal to 7</text>
	</g>
	<g transform="translate(168,46) rotate(-20.55) scale(0.8)">
		<text x="0" y="0" class="highfill">lesser than</text>
		<text x="0" y="1.2em" class="highfill">or equal to 7</text>
	</g>
</g>
</svg>
<br>
<p>The importance of a *self balancing* binary search tree is that we may add and remove nodes from
the tree while maintaining a logarithmic bound on the tree's height and a sorted ordering on the
nodes. This allows us to dynamically track and query data relatively quickly even on large data
sets.</p>
<br>
<p>We are now prepared to implement the various operations that will maintain the tree's logarithmic
height, and also the operations that can make use of the tree once it's populated.</p>
<br>
<h2>Rotations</h2>
<br>
<p>Rotations are the fundamental operation that trees use to rebalance nodes. They work by swapping a
node's position with one of it's children and, in the process, raise one of its children and lower
another. There are two type of rotations that can be performed: left rotations and right rotations.</p>
<br>
<p>Let us consider a left rotation on the node A below.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 171" class="diagram">
<g transform="translate(272,10)">
	<line x1="18" y1="78" x2="58" y2="18"/>
	<line x1="98" y1="78" x2="58" y2="18"/>
	<line x1="58" y1="138" x2="98" y2="78"/>
	<line x1="138" y1="138" x2="98" y2="78"/>
	<g class="bgfill highstroke">
		<circle cx="58" cy="18" r="17"/>
		<circle cx="18" cy="78" r="17"/>
		<circle cx="98" cy="78" r="17"/>
		<circle cx="58" cy="138" r="17"/>
		<circle cx="138" cy="138" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="58" y="18" dy="0.3em">A</text>
		<text x="18" y="78" dy="0.3em">x</text>
		<text x="98" y="78" dy="0.3em">B</text>
		<text x="58" y="138" dy="0.3em">y</text>
		<text x="138" y="138" dy="0.3em">z</text>
	</g>
</g>
<g transform="translate(467,55)">
	<line x1="0" y1="30" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="10" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="50" x2="70" y2="30" style="stroke-width:4"/>
</g>
<g transform="translate(572,10)">
	<line x1="58" y1="78" x2="98" y2="18"/>
	<line x1="138" y1="78" x2="98" y2="18"/>
	<line x1="18" y1="138" x2="58" y2="78"/>
	<line x1="98" y1="138" x2="58" y2="78"/>
	<g class="bgfill highstroke">
		<circle cx="98" cy="18" r="17"/>
		<circle cx="58" cy="78" r="17"/>
		<circle cx="138" cy="78" r="17"/>
		<circle cx="18" cy="138" r="17"/>
		<circle cx="98" cy="138" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="98" y="18" dy="0.3em">B</text>
		<text x="58" y="78" dy="0.3em">A</text>
		<text x="138" y="78" dy="0.3em">z</text>
		<text x="18" y="138" dy="0.3em">x</text>
		<text x="98" y="138" dy="0.3em">y</text>
	</g>
</g>
</svg>
<br>
<p>Note that node B will take the place of node A, wherever A was in the tree. It can be seen that this
left rotation has the effect of lowering the nodes on the left side of A, and raising the nodes on
the right. By doing this, the raised nodes have a shorter distance to the root node, and the lowered
nodes have a longer distance to the root. This raising and lowering effect is what we'll use to
rebalance a right-leaning node. The rotation also preserves the sorted order of the nodes by
maintaining the following inequalities:</p>
<br>
<div class="codeblock">x.key &lt;= A.key
A.key &lt;= y.key
y.key &lt;= B.key
B.key &lt;= z.key
</div>
<br>
<p>Likewise, a right rotation on node A looks like so:</p>
<br>
<svg version="1.1" viewBox="0 0 1000 171" class="diagram">
<g transform="translate(272,10)">
	<line x1="58" y1="78" x2="98" y2="18"/>
	<line x1="138" y1="78" x2="98" y2="18"/>
	<line x1="18" y1="138" x2="58" y2="78"/>
	<line x1="98" y1="138" x2="58" y2="78"/>
	<g class="bgfill highstroke">
		<circle cx="98" cy="18" r="17"/>
		<circle cx="58" cy="78" r="17"/>
		<circle cx="138" cy="78" r="17"/>
		<circle cx="18" cy="138" r="17"/>
		<circle cx="98" cy="138" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="98" y="18" dy="0.3em">A</text>
		<text x="58" y="78" dy="0.3em">B</text>
		<text x="138" y="78" dy="0.3em">z</text>
		<text x="18" y="138" dy="0.3em">x</text>
		<text x="98" y="138" dy="0.3em">y</text>
	</g>
</g>
<g transform="translate(467,55)">
	<line x1="0" y1="30" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="10" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="50" x2="70" y2="30" style="stroke-width:4"/>
</g>
<g transform="translate(572,10)">
	<line x1="18" y1="78" x2="58" y2="18"/>
	<line x1="98" y1="78" x2="58" y2="18"/>
	<line x1="58" y1="138" x2="98" y2="78"/>
	<line x1="138" y1="138" x2="98" y2="78"/>
	<g class="bgfill highstroke">
		<circle cx="58" cy="18" r="17"/>
		<circle cx="18" cy="78" r="17"/>
		<circle cx="98" cy="78" r="17"/>
		<circle cx="58" cy="138" r="17"/>
		<circle cx="138" cy="138" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="58" y="18" dy="0.3em">B</text>
		<text x="18" y="78" dy="0.3em">x</text>
		<text x="98" y="78" dy="0.3em">A</text>
		<text x="58" y="138" dy="0.3em">y</text>
		<text x="138" y="138" dy="0.3em">z</text>
	</g>
</g>
</svg>
<br>
<p>Right rotations can conversely be used to rebalance a node which is leaning to the left.</p>
<br>
<p>The python code to perform these rotations is given below. Note that the heights of nodes A and B
need to be recalculated after each rotation, since their childs' heights may have changed.</p>
<br>
<div class="codeblock langpython">def rotleft(a):
	b=a.right
	a.right=b.left
	b.left=a
	b.parent=a.parent
	a.parent=b
	if a.right: a.right.parent=a
	a.calcheight()
	b.calcheight()
	return b

def rotright(a):
	b=a.left
	a.left=b.right
	b.right=a
	b.parent=a.parent
	a.parent=b
	if a.left: a.left.parent=a
	a.calcheight()
	b.calcheight()
	return b

def calcheight(self):
	l,r=self.left,self.right
	lh=l.height if l else -1
	rh=r.height if r else -1
	self.height=(lh if lh>rh else rh)+1</div>
<br>
<p>We will show a concrete of example of how rotations are used to rebalance a tree in the next
section.</p>
<br>
<h2>Balancing</h2>
<br>
<p>As we add and remove nodes from the tree, the tree will become lopsided; with some branches becoming
extremely long and some extremely short. In order to maintain an <i>O(log(n))</i> worst-case performance
bound on tree operations, the tree will need to be rebalanced periodically.</p>
<br>
<p>Ideally, in a perfectly balanced tree, all branches will have lengths equal to the shortest branch
or equal to the shortest+1. However, since we're working with a tree that can be updated
dynamically, we will have to allow some slack in balancing the tree in order to balance in a timely
manner. That is, if we're too strict with rebalancing, the act of rebalancing will take longer than
any time we might save by using a self balancing tree.</p>
<br>
<p>Different trees have different criteria for deciding when to rebalance. Since we're making an AVL
tree, balancing is performed by keeping all sibling heights within ±1 of eachother. For example: if
a node's left child has a height of 2, and its right child has a height of 0, their difference in
height is 0-2=-2, which is imbalanced. Formally, the balance of a node is calculated as
<i>balance=node.right.height-node.left.height</i>, and we want <i>-1&lt;=balance&lt;=1</i> for all nodes.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 382" class="diagram">
<g transform="translate(310,10)">
	<line x1="139" y1="79" x2="219" y2="19"/>
	<line x1="299" y1="79" x2="219" y2="19"/>
	<line x1="99" y1="139" x2="139" y2="79"/>
	<line x1="179" y1="139" x2="139" y2="79"/>
	<line x1="259" y1="139" x2="299" y2="79"/>
	<line x1="339" y1="139" x2="299" y2="79"/>
	<line x1="59" y1="199" x2="99" y2="139"/>
	<line x1="139" y1="199" x2="99" y2="139"/>
	<line x1="19" y1="259" x2="59" y2="199"/>
	<line x1="99" y1="259" x2="59" y2="199"/>
	<g class="bgfill highstroke">
		<circle cx="219" cy="19" r="17"/>
		<circle cx="139" cy="79" r="17"/>
		<circle cx="299" cy="79" r="17"/>
		<circle cx="99" cy="139" r="17"/>
		<circle cx="179" cy="139" r="17"/>
		<circle cx="259" cy="139" r="17"/>
		<circle cx="339" cy="139" r="17"/>
		<circle cx="59" cy="199" r="17"/>
		<circle cx="139" cy="199" r="17"/>
		<circle cx="19" cy="259" r="17"/>
		<circle cx="99" cy="259" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="219" y="20" dy="0.3em">D</text>
		<text x="139" y="80" dy="0.3em">C</text>
		<text x="299" y="80" dy="0.3em">E</text>
		<text x="99" y="140" dy="0.3em">B</text>
		<text x="59" y="200" dy="0.3em">A</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="179" y="140" dy="0.3em">NUL</text>
		<text x="259" y="140" dy="0.3em">NUL</text>
		<text x="339" y="140" dy="0.3em">NUL</text>
		<text x="139" y="200" dy="0.3em">NUL</text>
		<text x="19" y="260" dy="0.3em">NUL</text>
		<text x="99" y="260" dy="0.3em">NUL</text>
	</g>
</g>
<g transform="translate(330,330)">
	<text x="0" y="0">height(E) = 0</text>
	<text x="0" y="0" dy="1.2em">height(C) = 2</text>
	<text x="0" y="0" dy="2.4em">balance(D) = height(E)-height(C) = -2</text>
</g>
</svg>
<br>
<p>To actually rebalance a node, we will make use of rotations. Note from the previous section that
left and right rotations affect the heights of nodes differently. In particular, rotating to the
left tilts the node's children to the left, and rotating to the right tilts them to the right. In
both rotations, the middle node (denoted by "y" in the section above) doesn't raise or lower. Thus,
for a node leaning to the left, we have the following cases:</p>
<br>
<table class="listtable">
<tr><td>1.</td><td>If <i>left.height&gt;right.height+1</i>, then <i>rotright(node)</i>.</td></tr>
<tr><td>2.</td><td>If <i>left.height&gt;right.height+1</i> and <i>left.left.height&lt;left.right.height</i>,
then <i>rotleft(left)</i> and <i>rotright(node)</i>.</td></tr>
</table>
<br>
<p>Case 1 is the most trivial example of node rebalancing.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 370" class="diagram">
<g transform="translate(170,20)">
	<text x="330" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 1</text>
	<rect x="0" y="20" width="660" height="320" stroke-width="1" fill="none"/>
	<line x1="0" y1="280" x2="660" y2="280" style="stroke-width:1"/>
	<line x1="330" y1="20" x2="330" y2="280" style="stroke-width:1"/>
	<g transform="translate(320,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(320,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(20,40) scale(0.8)">
		<line x1="139" y1="79" x2="219" y2="19"/>
		<line x1="299" y1="79" x2="219" y2="19"/>
		<line x1="99" y1="139" x2="139" y2="79"/>
		<line x1="179" y1="139" x2="139" y2="79"/>
		<line x1="259" y1="139" x2="299" y2="79"/>
		<line x1="339" y1="139" x2="299" y2="79"/>
		<line x1="59" y1="199" x2="99" y2="139"/>
		<line x1="139" y1="199" x2="99" y2="139"/>
		<line x1="19" y1="259" x2="59" y2="199"/>
		<line x1="99" y1="259" x2="59" y2="199"/>
		<g class="bgfill highstroke">
			<circle cx="219" cy="19" r="17"/>
			<circle cx="139" cy="79" r="17"/>
			<circle cx="299" cy="79" r="17"/>
			<circle cx="99" cy="139" r="17"/>
			<circle cx="179" cy="139" r="17"/>
			<circle cx="259" cy="139" r="17"/>
			<circle cx="339" cy="139" r="17"/>
			<circle cx="59" cy="199" r="17"/>
			<circle cx="139" cy="199" r="17"/>
			<circle cx="19" cy="259" r="17"/>
			<circle cx="99" cy="259" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:130%">
			<text x="219" y="20" dy="0.3em">4</text>
			<text x="139" y="80" dy="0.3em">3</text>
			<text x="299" y="80" dy="0.3em">5</text>
			<text x="99" y="140" dy="0.3em">2</text>
			<text x="59" y="200" dy="0.3em">1</text>
		</g>
		<g text-anchor="middle" style="font-size:80%">
			<text x="179" y="140" dy="0.3em">NUL</text>
			<text x="259" y="140" dy="0.3em">NUL</text>
			<text x="339" y="140" dy="0.3em">NUL</text>
			<text x="139" y="200" dy="0.3em">NUL</text>
			<text x="19" y="260" dy="0.3em">NUL</text>
			<text x="99" y="260" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(65,307)">
		<text x="0" y="0">height(5)-height(3)=-2</text>
		<text x="0" y="0" dy="1.2em">rotright(4)</text>
	</g>
	<g transform="translate(350,40) scale(0.8)">
		<line x1="99" y1="79" x2="179" y2="19"/>
		<line x1="259" y1="79" x2="179" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<line x1="219" y1="139" x2="259" y2="79"/>
		<line x1="299" y1="139" x2="259" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<line x1="259" y1="199" x2="299" y2="139"/>
		<line x1="339" y1="199" x2="299" y2="139"/>
		<g class="bgfill highstroke">
			<circle cx="179" cy="19" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="259" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
			<circle cx="219" cy="139" r="17"/>
			<circle cx="299" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
			<circle cx="259" cy="199" r="17"/>
			<circle cx="339" cy="199" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:130%">
			<text x="179" y="20" dy="0.3em">3</text>
			<text x="99" y="80" dy="0.3em">2</text>
			<text x="259" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">1</text>
			<text x="299" y="140" dy="0.3em">5</text>
		</g>
		<g text-anchor="middle" style="font-size:80%">
			<text x="139" y="140" dy="0.3em">NUL</text>
			<text x="219" y="140" dy="0.3em">NUL</text>
			<text x="19" y="200" dy="0.3em">NUL</text>
			<text x="99" y="200" dy="0.3em">NUL</text>
			<text x="259" y="200" dy="0.3em">NUL</text>
			<text x="339" y="200" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(405,307)">
		<text x="0" y="0">height(4)-height(2)=0</text>
		<text x="0" y="0" dy="1.2em">Balanced!</text>
	</g>
</g>
</svg>
<br>
<p>Case 2 is a result of the middle node staying the same height throughout a rotation on a node. If
the middle node is actually the longest, then we must left rotate the node's left child before
actually rotating the node. The example below shows what would happen if we didn't make this
correction.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 370" class="diagram">
<g transform="translate(105,20)">
	<text x="395" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 2 - Incorrect</text>
	<rect x="0" y="20" width="790" height="320" stroke-width="1" fill="none"/>
	<line x1="0" y1="280" x2="790" y2="280" style="stroke-width:1"/>
	<line x1="395" y1="20" x2="395" y2="280" style="stroke-width:1"/>
	<g transform="translate(385,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(385,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(20,40) scale(0.8)">
		<line x1="139" y1="79" x2="259" y2="19"/>
		<line x1="379" y1="79" x2="259" y2="19"/>
		<line x1="59" y1="139" x2="139" y2="79"/>
		<line x1="219" y1="139" x2="139" y2="79"/>
		<line x1="339" y1="139" x2="379" y2="79"/>
		<line x1="419" y1="139" x2="379" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<line x1="179" y1="199" x2="219" y2="139"/>
		<line x1="259" y1="199" x2="219" y2="139"/>
		<line x1="219" y1="259" x2="259" y2="199"/>
		<line x1="299" y1="259" x2="259" y2="199"/>
		<g class="bgfill highstroke">
			<circle cx="259" cy="19" r="17"/>
			<circle cx="139" cy="79" r="17"/>
			<circle cx="379" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="219" cy="139" r="17"/>
			<circle cx="339" cy="139" r="17"/>
			<circle cx="419" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
			<circle cx="179" cy="199" r="17"/>
			<circle cx="259" cy="199" r="17"/>
			<circle cx="219" cy="259" r="17"/>
			<circle cx="299" cy="259" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:150%">
			<text x="259" y="20" dy="0.3em">5</text>
			<text x="139" y="80" dy="0.3em">2</text>
			<text x="379" y="80" dy="0.3em">6</text>
			<text x="59" y="140" dy="0.3em">1</text>
			<text x="219" y="140" dy="0.3em">3</text>
			<text x="259" y="200" dy="0.3em">4</text>
		</g>
		<g text-anchor="middle">
			<text x="339" y="140" dy="0.3em">NUL</text>
			<text x="419" y="140" dy="0.3em">NUL</text>
			<text x="19" y="200" dy="0.3em">NUL</text>
			<text x="99" y="200" dy="0.3em">NUL</text>
			<text x="179" y="200" dy="0.3em">NUL</text>
			<text x="219" y="260" dy="0.3em">NUL</text>
			<text x="299" y="260" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(90,307)">
		<text x="0" y="0">height(6)-height(2)=-2</text>
		<text x="0" y="0" dy="1.2em">rotright(5)</text>
	</g>
	<g transform="translate(420,40) scale(0.8)">
		<line x1="59" y1="79" x2="179" y2="19"/>
		<line x1="299" y1="79" x2="179" y2="19"/>
		<line x1="19" y1="139" x2="59" y2="79"/>
		<line x1="99" y1="139" x2="59" y2="79"/>
		<line x1="219" y1="139" x2="299" y2="79"/>
		<line x1="379" y1="139" x2="299" y2="79"/>
		<line x1="179" y1="199" x2="219" y2="139"/>
		<line x1="259" y1="199" x2="219" y2="139"/>
		<line x1="339" y1="199" x2="379" y2="139"/>
		<line x1="419" y1="199" x2="379" y2="139"/>
		<line x1="219" y1="259" x2="259" y2="199"/>
		<line x1="299" y1="259" x2="259" y2="199"/>
		<g class="bgfill highstroke">
			<circle cx="179" cy="19" r="17"/>
			<circle cx="59" cy="79" r="17"/>
			<circle cx="299" cy="79" r="17"/>
			<circle cx="19" cy="139" r="17"/>
			<circle cx="99" cy="139" r="17"/>
			<circle cx="219" cy="139" r="17"/>
			<circle cx="379" cy="139" r="17"/>
			<circle cx="179" cy="199" r="17"/>
			<circle cx="259" cy="199" r="17"/>
			<circle cx="339" cy="199" r="17"/>
			<circle cx="419" cy="199" r="17"/>
			<circle cx="219" cy="259" r="17"/>
			<circle cx="299" cy="259" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:150%">
			<text x="179" y="20" dy="0.3em">2</text>
			<text x="59" y="80" dy="0.3em">1</text>
			<text x="299" y="80" dy="0.3em">5</text>
			<text x="219" y="140" dy="0.3em">3</text>
			<text x="379" y="140" dy="0.3em">6</text>
			<text x="259" y="200" dy="0.3em">4</text>
		</g>
		<g text-anchor="middle">
			<text x="19" y="140" dy="0.3em">NUL</text>
			<text x="99" y="140" dy="0.3em">NUL</text>
			<text x="179" y="200" dy="0.3em">NUL</text>
			<text x="339" y="200" dy="0.3em">NUL</text>
			<text x="419" y="200" dy="0.3em">NUL</text>
			<text x="219" y="260" dy="0.3em">NUL</text>
			<text x="299" y="260" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(500,307)">
		<text x="0" y="0">height(5)-height(1)=2</text>
		<text x="0" y="0" dy="1.2em">Not balanced!</text>
	</g>
</g>
</svg>
<br>
<p>Rotating the left child beforehand results in a correctly balanced tree.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 310" class="diagram">
<g transform="translate(20,20)">
	<text x="480" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 2 - Correct</text>
	<rect x="0" y="20" width="960" height="260" stroke-width="1" fill="none"/>
	<line x1="0" y1="220" x2="960" y2="220" style="stroke-width:1"/>
	<line x1="303" y1="20" x2="303" y2="220" style="stroke-width:1"/>
	<line x1="630" y1="20" x2="630" y2="220" style="stroke-width:1"/>
	<g transform="translate(293,233)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(293,257)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(620,233)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(620,257)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(20,40) scale(0.6)">
		<line x1="139" y1="79" x2="259" y2="19"/>
		<line x1="379" y1="79" x2="259" y2="19"/>
		<line x1="59" y1="139" x2="139" y2="79"/>
		<line x1="219" y1="139" x2="139" y2="79"/>
		<line x1="339" y1="139" x2="379" y2="79"/>
		<line x1="419" y1="139" x2="379" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<line x1="179" y1="199" x2="219" y2="139"/>
		<line x1="259" y1="199" x2="219" y2="139"/>
		<line x1="219" y1="259" x2="259" y2="199"/>
		<line x1="299" y1="259" x2="259" y2="199"/>
		<g class="bgfill highstroke">
			<circle cx="259" cy="19" r="17"/>
			<circle cx="139" cy="79" r="17"/>
			<circle cx="379" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="219" cy="139" r="17"/>
			<circle cx="339" cy="139" r="17"/>
			<circle cx="419" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
			<circle cx="179" cy="199" r="17"/>
			<circle cx="259" cy="199" r="17"/>
			<circle cx="219" cy="259" r="17"/>
			<circle cx="299" cy="259" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:150%">
			<text x="259" y="20" dy="0.3em">5</text>
			<text x="139" y="80" dy="0.3em">2</text>
			<text x="379" y="80" dy="0.3em">6</text>
			<text x="59" y="140" dy="0.3em">1</text>
			<text x="219" y="140" dy="0.3em">3</text>
			<text x="259" y="200" dy="0.3em">4</text>
		</g>
		<g text-anchor="middle">
			<text x="339" y="140" dy="0.3em">NUL</text>
			<text x="419" y="140" dy="0.3em">NUL</text>
			<text x="19" y="200" dy="0.3em">NUL</text>
			<text x="99" y="200" dy="0.3em">NUL</text>
			<text x="179" y="200" dy="0.3em">NUL</text>
			<text x="219" y="260" dy="0.3em">NUL</text>
			<text x="299" y="260" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(65,247)">
		<text x="0" y="0">height(1)&lt;height(3)</text>
		<text x="0" y="0" dy="1.2em">rotleft(2)</text>
	</g>
	<g transform="translate(323,40) scale(0.6)">
		<line x1="179" y1="79" x2="299" y2="19"/>
		<line x1="419" y1="79" x2="299" y2="19"/>
		<line x1="99" y1="139" x2="179" y2="79"/>
		<line x1="259" y1="139" x2="179" y2="79"/>
		<line x1="379" y1="139" x2="419" y2="79"/>
		<line x1="459" y1="139" x2="419" y2="79"/>
		<line x1="59" y1="199" x2="99" y2="139"/>
		<line x1="139" y1="199" x2="99" y2="139"/>
		<line x1="219" y1="199" x2="259" y2="139"/>
		<line x1="299" y1="199" x2="259" y2="139"/>
		<line x1="19" y1="259" x2="59" y2="199"/>
		<line x1="99" y1="259" x2="59" y2="199"/>
		<g class="bgfill highstroke">
			<circle cx="299" cy="19" r="17"/>
			<circle cx="179" cy="79" r="17"/>
			<circle cx="419" cy="79" r="17"/>
			<circle cx="99" cy="139" r="17"/>
			<circle cx="259" cy="139" r="17"/>
			<circle cx="379" cy="139" r="17"/>
			<circle cx="459" cy="139" r="17"/>
			<circle cx="59" cy="199" r="17"/>
			<circle cx="139" cy="199" r="17"/>
			<circle cx="219" cy="199" r="17"/>
			<circle cx="299" cy="199" r="17"/>
			<circle cx="19" cy="259" r="17"/>
			<circle cx="99" cy="259" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:150%">
			<text x="299" y="20" dy="0.3em">5</text>
			<text x="179" y="80" dy="0.3em">3</text>
			<text x="419" y="80" dy="0.3em">6</text>
			<text x="99" y="140" dy="0.3em">2</text>
			<text x="259" y="140" dy="0.3em">4</text>
			<text x="59" y="200" dy="0.3em">1</text>
		</g>
		<g text-anchor="middle">
			<text x="379" y="140" dy="0.3em">NUL</text>
			<text x="459" y="140" dy="0.3em">NUL</text>
			<text x="139" y="200" dy="0.3em">NUL</text>
			<text x="219" y="200" dy="0.3em">NUL</text>
			<text x="299" y="200" dy="0.3em">NUL</text>
			<text x="19" y="260" dy="0.3em">NUL</text>
			<text x="99" y="260" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(410,247)">
		<text x="0" y="0">rotright(5)</text>
	</g>
	<g transform="translate(650,40) scale(0.6)">
		<line x1="99" y1="79" x2="219" y2="19"/>
		<line x1="339" y1="79" x2="219" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<line x1="259" y1="139" x2="339" y2="79"/>
		<line x1="419" y1="139" x2="339" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<line x1="219" y1="199" x2="259" y2="139"/>
		<line x1="299" y1="199" x2="259" y2="139"/>
		<line x1="379" y1="199" x2="419" y2="139"/>
		<line x1="459" y1="199" x2="419" y2="139"/>
		<g class="bgfill highstroke">
			<circle cx="219" cy="19" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="339" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
			<circle cx="259" cy="139" r="17"/>
			<circle cx="419" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
			<circle cx="219" cy="199" r="17"/>
			<circle cx="299" cy="199" r="17"/>
			<circle cx="379" cy="199" r="17"/>
			<circle cx="459" cy="199" r="17"/>
		</g>
		<g text-anchor="middle" style="font-size:150%">
			<text x="219" y="20" dy="0.3em">3</text>
			<text x="99" y="80" dy="0.3em">2</text>
			<text x="339" y="80" dy="0.3em">5</text>
			<text x="59" y="140" dy="0.3em">1</text>
			<text x="259" y="140" dy="0.3em">4</text>
			<text x="419" y="140" dy="0.3em">6</text>
		</g>
		<g text-anchor="middle">
			<text x="139" y="140" dy="0.3em">NUL</text>
			<text x="19" y="200" dy="0.3em">NUL</text>
			<text x="99" y="200" dy="0.3em">NUL</text>
			<text x="219" y="200" dy="0.3em">NUL</text>
			<text x="299" y="200" dy="0.3em">NUL</text>
			<text x="379" y="200" dy="0.3em">NUL</text>
			<text x="459" y="200" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(700,247)">
		<text x="0" y="0">height(5)-height(2)=0</text>
		<text x="0" y="0" dy="1.2em">Balanced!</text>
	</g>
</g>
</svg>
<br>
<p>The cases where a node is leaning to the right are handled exactly the same, only all "left" and
"right" references are swapped, including rotations.</p>
<br>
<p>The code below is our full rebalancing function. In practice, when we need to perform rebalancing,
we won't need to check all nodes in the tree to see if their children will need to be moved.
Instead, when adding and removing, we will be able to get away with the finding deepest node
affected by the modification and, then, balancing that node and its parents until we find a node
that's already balanced.</p>
<br>
<div class="codeblock langpython">def rebalance(tree,node):
	#Rebalance from node upward.
	def H(n): return n.height if n else -1
	while node:
		orig=node
		l,r=node.left,node.right
		lh,rh,nh=H(l),H(r),node.height
		if lh&gt;rh+1:
			if H(l.left)&lt;H(l.right): node.left=l.rotleft()
			node=node.rotright()
		elif rh&gt;lh+1:
			if H(r.right)&lt;H(r.left): node.right=r.rotright()
			node=node.rotleft()
		else:
			node.height=(lh if lh&gt;rh else rh)+1
		prev=node.parent
		if prev:
			if prev.right is orig: prev.right=node
			else: prev.left=node
		else:
			tree.root=node
		if node.height==nh: break
		node=prev</div>
<br>
<h2>Searching</h2>
<br>
<p>When defining binary search trees, we stated that any child to the left of a node will satisfy
<i>child.key&lt;=node.key</i>, and any child to the right will satisfy <i>child.key&gt;=node.key</i>. While this
property allows us to search for nodes, it also presents a problem since the tree can have multiple
nodes with the same key. In such a case, which node should we return when searching for a key?</p>
<br>
<p>For the purposes of this article, we will have the search function return the last node going by
sorted order. Thus, the rules it will follow are:</p>
<br>
<table class="listtable">
<tr><td></td><td>Start at the root node.</td></tr>
<tr><td></td><td>If <i>key&lt;node.key</i>, then move to the node's left child.</td></tr>
<tr><td></td><td>If <i>key&gt;=node.key</i>, then move to the node's right child.</td></tr>
<tr><td></td><td>Continue until we reach a null node.</td></tr>
<tr><td></td><td>Return the last node with <i>key=node.key</i>.</td></tr>
</table>
<br>
<p>For example, assume we want to search for <i>key=5</i> in the following tree.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 288" class="diagram">
<g transform="translate(176,10)">
	<line x1="139" y1="79" x2="299" y2="19" stroke-width="4" class="highstroke"/>
	<line x1="459" y1="79" x2="299" y2="19"/>
	<line x1="59" y1="139" x2="139" y2="79"/>
	<line x1="219" y1="139" x2="139" y2="79" stroke-width="4" class="highstroke"/>
	<line x1="379" y1="139" x2="459" y2="79"/>
	<line x1="539" y1="139" x2="459" y2="79"/>
	<line x1="19" y1="199" x2="59" y2="139"/>
	<line x1="99" y1="199" x2="59" y2="139"/>
	<line x1="179" y1="199" x2="219" y2="139"/>
	<line x1="259" y1="199" x2="219" y2="139" stroke-width="4" class="highstroke"/>
	<line x1="339" y1="199" x2="379" y2="139"/>
	<line x1="419" y1="199" x2="379" y2="139"/>
	<line x1="499" y1="199" x2="539" y2="139"/>
	<line x1="579" y1="199" x2="539" y2="139"/>
	<line x1="259" y1="199" x2="219" y2="259" stroke-width="4" class="highstroke"/>
	<g class="bgfill highstroke">
		<circle cx="299" cy="19" r="17"/>
		<circle cx="139" cy="79" r="17"/>
		<circle cx="459" cy="79" r="17"/>
		<circle cx="59" cy="139" r="17"/>
		<circle cx="219" cy="139" r="17"/>
		<circle cx="379" cy="139" r="17"/>
		<circle cx="539" cy="139" r="17"/>
		<circle cx="19" cy="199" r="17"/>
		<circle cx="99" cy="199" r="17"/>
		<circle cx="179" cy="199" r="17"/>
		<circle cx="259" cy="199" r="17"/>
		<circle cx="339" cy="199" r="17"/>
		<circle cx="419" cy="199" r="17"/>
		<circle cx="499" cy="199" r="17"/>
		<circle cx="579" cy="199" r="17"/>
		<circle cx="219" cy="259" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="299" y="20" dy="0.3em">7</text>
		<text x="139" y="80" dy="0.3em">3</text>
		<text x="459" y="80" dy="0.3em">11</text>
		<text x="59" y="140" dy="0.3em">1</text>
		<text x="219" y="140" dy="0.3em">5</text>
		<text x="379" y="140" dy="0.3em">9</text>
		<text x="539" y="140" dy="0.3em">13</text>
		<text x="19" y="200" dy="0.3em">0</text>
		<text x="99" y="200" dy="0.3em">2</text>
		<text x="179" y="200" dy="0.3em">4</text>
		<text x="259" y="200" dy="0.3em">6</text>
		<text x="339" y="200" dy="0.3em">8</text>
		<text x="419" y="200" dy="0.3em">10</text>
		<text x="499" y="200" dy="0.3em">12</text>
		<text x="579" y="200" dy="0.3em">14</text>
		<text x="219" y="260" dy="0.3em" style="font-size:80%">NUL</text>
	</g>
	<g style="font-size:80%">
		<text x="326" y="10" class="highfill">start at the root</text>
		<text x="326" y="10" dy="1.2em" class="highfill">5&lt;7: go left</text>
		<text x="165" y="80" dy="0.3em" class="highfill">5&gt;3: go right</text>
		<text x="245" y="135" class="highfill">5=5: go right</text>
		<text x="245" y="135" dy="1.2em" class="highfill">record node</text>
		<text x="270" y="230" class="highfill">5&lt;6: go left</text>
		<text x="245" y="260" dy="0.3em" class="highfill">null node: abort</text>
	</g>
</g>
</svg>
<br>
<p>The python code below shows how our basic search function works.</p>
<br>
<div class="codeblock langpython">def search(tree,key):
	node,ret=tree.root,None
	while node:
		if key&gt;=node.key:
			if key==node.key: ret=node
			node=node.right
		else:
			node=node.left
	return ret
</div>
<br>
<p>In <a href="./SBTree.py">SBTree.py</a>, the search function has been expanded to allow us to query different ranges in the
tree. They include:</p>
<br>
<table class="listtable">
<tr><td>&bull;</td><td>Return some <i>node=key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the least <i>node=key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the least <i>node&gt;key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the least <i>node&gt;=key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the greatest <i>node=key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the greatest <i>node&lt;key</i>.</td></tr>
<tr><td>&bull;</td><td>Return the greatest <i>node&lt;=key</i>.</td></tr>
</table>
<br>
<h2>Adding</h2>
<br>
<p>Adding nodes is as simple as finding where the node would be if we searched for it, adding it as a
child, and then balancing up. Because we defined our search function to go right whenever
<i>key&gt;=node.key</i>, this will stably (in the sorting sense) add the node to the tree.</p>
<br>
<p>For instance, assume we want to add <i>key=4</i> to the following tree:</p>
<br>
<svg version="1.1" viewBox="0 0 1000 288" class="diagram">
<g transform="translate(30,10)">
	<line x1="59" y1="79" x2="139" y2="19"/>
	<line x1="219" y1="79" x2="139" y2="19" stroke-width="4" class="highstroke"/>
	<line x1="19" y1="139" x2="59" y2="79"/>
	<line x1="99" y1="139" x2="59" y2="79"/>
	<line x1="179" y1="139" x2="219" y2="79"/>
	<line x1="259" y1="139" x2="219" y2="79" stroke-width="4" class="highstroke"/>
	<line x1="219" y1="199" x2="259" y2="139"/>
	<line x1="299" y1="199" x2="259" y2="139" stroke-width="4" class="highstroke"/>
	<g class="bgfill highstroke">
		<circle cx="139" cy="19" r="17"/>
		<circle cx="59" cy="79" r="17"/>
		<circle cx="219" cy="79" r="17"/>
		<circle cx="19" cy="139" r="17"/>
		<circle cx="99" cy="139" r="17"/>
		<circle cx="179" cy="139" r="17"/>
		<circle cx="259" cy="139" r="17"/>
		<circle cx="219" cy="199" r="17"/>
		<circle cx="299" cy="199" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="139" y="20" dy="0.3em">1</text>
		<text x="59" y="80" dy="0.3em">0</text>
		<text x="219" y="80" dy="0.3em">2</text>
		<text x="259" y="140" dy="0.3em">3</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="19" y="140" dy="0.3em">NUL</text>
		<text x="99" y="140" dy="0.3em">NUL</text>
		<text x="179" y="140" dy="0.3em">NUL</text>
		<text x="219" y="200" dy="0.3em">NUL</text>
		<text x="299" y="200" dy="0.3em">NUL</text>
	</g>
	<g>
		<text x="165" y="11" class="highfill">start at the root</text>
		<text x="165" y="11" dy="1.2em" class="highfill">4&gt;1: go right</text>
		<text x="245" y="80" dy="0.3em" class="highfill">4&gt;2: go right</text>
		<text x="285" y="140" dy="0.3em" class="highfill">4&gt;3: go right</text>
		<text x="325" y="192" class="highfill">null node</text>
		<text x="325" y="192" dy="1.2em" class="highfill">place 4 here</text>
	</g>
</g>
<g transform="translate(475,80)">
	<line x1="0" y1="30" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="10" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="50" x2="70" y2="30" style="stroke-width:4"/>
</g>
<g transform="translate(600,10)">
	<line x1="59" y1="79" x2="139" y2="19"/>
	<line x1="219" y1="79" x2="139" y2="19"/>
	<line x1="19" y1="139" x2="59" y2="79"/>
	<line x1="99" y1="139" x2="59" y2="79"/>
	<line x1="179" y1="139" x2="219" y2="79"/>
	<line x1="259" y1="139" x2="219" y2="79"/>
	<line x1="219" y1="199" x2="259" y2="139"/>
	<line x1="299" y1="199" x2="259" y2="139"/>
	<line x1="259" y1="259" x2="299" y2="199"/>
	<line x1="339" y1="259" x2="299" y2="199"/>
	<g class="bgfill highstroke">
		<circle cx="139" cy="19" r="17"/>
		<circle cx="59" cy="79" r="17"/>
		<circle cx="219" cy="79" r="17"/>
		<circle cx="19" cy="139" r="17"/>
		<circle cx="99" cy="139" r="17"/>
		<circle cx="179" cy="139" r="17"/>
		<circle cx="259" cy="139" r="17"/>
		<circle cx="219" cy="199" r="17"/>
		<circle cx="299" cy="199" r="17"/>
		<circle cx="259" cy="259" r="17"/>
		<circle cx="339" cy="259" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="139" y="20" dy="0.3em">1</text>
		<text x="59" y="80" dy="0.3em">0</text>
		<text x="219" y="80" dy="0.3em">2</text>
		<text x="259" y="140" dy="0.3em">3</text>
		<text x="299" y="200" dy="0.3em">4</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="19" y="140" dy="0.3em">NUL</text>
		<text x="99" y="140" dy="0.3em">NUL</text>
		<text x="179" y="140" dy="0.3em">NUL</text>
		<text x="219" y="200" dy="0.3em">NUL</text>
		<text x="259" y="260" dy="0.3em">NUL</text>
		<text x="339" y="260" dy="0.3em">NUL</text>
	</g>
</g>
</svg>
<br>
<p>We would then balance from node 3 upwards until we encounter a node whose height hasn't changed
because of the added node.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 279" class="diagram">
<g transform="translate(20,10) scale(0.93)">
	<line x1="59" y1="79" x2="139" y2="19"/>
	<line x1="219" y1="79" x2="139" y2="19"/>
	<line x1="19" y1="139" x2="59" y2="79"/>
	<line x1="99" y1="139" x2="59" y2="79"/>
	<line x1="179" y1="139" x2="219" y2="79"/>
	<line x1="259" y1="139" x2="219" y2="79"  stroke-width="4" class="highstroke"/>
	<line x1="219" y1="199" x2="259" y2="139"/>
	<line x1="299" y1="199" x2="259" y2="139"  stroke-width="4" class="highstroke"/>
	<line x1="259" y1="259" x2="299" y2="199"/>
	<line x1="339" y1="259" x2="299" y2="199"/>
	<g class="bgfill highstroke">
		<circle cx="139" cy="19" r="17"/>
		<circle cx="59" cy="79" r="17"/>
		<circle cx="219" cy="79" r="17"/>
		<circle cx="19" cy="139" r="17"/>
		<circle cx="99" cy="139" r="17"/>
		<circle cx="179" cy="139" r="17"/>
		<circle cx="259" cy="139" r="17"/>
		<circle cx="219" cy="199" r="17"/>
		<circle cx="299" cy="199" r="17"/>
		<circle cx="259" cy="259" r="17"/>
		<circle cx="339" cy="259" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="139" y="20" dy="0.3em">1</text>
		<text x="59" y="80" dy="0.3em">0</text>
		<text x="219" y="80" dy="0.3em">2</text>
		<text x="259" y="140" dy="0.3em">3</text>
		<text x="299" y="200" dy="0.3em">4</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="19" y="140" dy="0.3em">NUL</text>
		<text x="99" y="140" dy="0.3em">NUL</text>
		<text x="179" y="140" dy="0.3em">NUL</text>
		<text x="219" y="200" dy="0.3em">NUL</text>
		<text x="259" y="260" dy="0.3em">NUL</text>
		<text x="339" y="260" dy="0.3em">NUL</text>
	</g>
	<g>
		<text x="245" y="75" class="highfill">balance=1-(-1)=2</text>
		<text x="245" y="75" dy="1.2em" class="highfill">rotate left</text>
		<text x="285" y="135" class="highfill">height changed</text>
		<text x="285" y="135" dy="1.2em" class="highfill">continue</text>
	</g>
</g>
<g transform="translate(460,85)">
	<line x1="0" y1="30" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="10" x2="70" y2="30" style="stroke-width:4"/>
	<line x1="50" y1="50" x2="70" y2="30" style="stroke-width:4"/>
</g>
<g transform="translate(570,10) scale(0.93)">
	<line x1="59" y1="79" x2="179" y2="19"/>
	<line x1="299" y1="79" x2="179" y2="19" stroke-width="4" class="highstroke"/>
	<line x1="19" y1="139" x2="59" y2="79"/>
	<line x1="99" y1="139" x2="59" y2="79"/>
	<line x1="219" y1="139" x2="299" y2="79"/>
	<line x1="379" y1="139" x2="299" y2="79"/>
	<line x1="179" y1="199" x2="219" y2="139"/>
	<line x1="259" y1="199" x2="219" y2="139"/>
	<line x1="339" y1="199" x2="379" y2="139"/>
	<line x1="419" y1="199" x2="379" y2="139"/>
	<g class="bgfill highstroke">
		<circle cx="179" cy="19" r="17"/>
		<circle cx="59" cy="79" r="17"/>
		<circle cx="299" cy="79" r="17"/>
		<circle cx="19" cy="139" r="17"/>
		<circle cx="99" cy="139" r="17"/>
		<circle cx="219" cy="139" r="17"/>
		<circle cx="379" cy="139" r="17"/>
		<circle cx="179" cy="199" r="17"/>
		<circle cx="259" cy="199" r="17"/>
		<circle cx="339" cy="199" r="17"/>
		<circle cx="419" cy="199" r="17"/>
	</g>
	<g text-anchor="middle">
		<text x="179" y="20" dy="0.3em">1</text>
		<text x="59" y="80" dy="0.3em">0</text>
		<text x="299" y="80" dy="0.3em">3</text>
		<text x="219" y="140" dy="0.3em">2</text>
		<text x="379" y="140" dy="0.3em">4</text>
	</g>
	<g text-anchor="middle" style="font-size:80%">
		<text x="19" y="140" dy="0.3em">NUL</text>
		<text x="99" y="140" dy="0.3em">NUL</text>
		<text x="179" y="200" dy="0.3em">NUL</text>
		<text x="259" y="200" dy="0.3em">NUL</text>
		<text x="339" y="200" dy="0.3em">NUL</text>
		<text x="419" y="200" dy="0.3em">NUL</text>
	</g>
	<g>
		<text x="210" y="10" class="highfill">height unchanged</text>
		<text x="210" y="10" dy="1.2em" class="highfill">abort</text>
	</g>
</g>
</svg>
<br>
<p>The code for adding nodes is given below. Note that this function will always add a new key.
Implementations that require duplicate key additions to replace old values will need to modify the
<i>add()</i> function.</p>
<br>
<div class="codeblock langpython">def add(tree,key,value=None):
	prev,node=None,tree.root
	c=0
	while node:
		prev=node
		c=key&gt;=node.key
		if c: node=node.right
		else: node=node.left
	node=Node(key,value)
	if prev:
		node.parent=prev
		if c: prev.right=node
		else: prev.left=node
	tree.rebalance(node)
	return node</div>
<br>
<h2>Traversal</h2>
<br>
<p>Given a particular node in the tree, we may be interested in finding the next or previous node going
by sorted order. That is, if this tree was a sorted array, what would the next and previous elements
be?</p>
<br>
<p>Finding <i>next(node)</i> for some node can be split into 2 cases:</p>
<br>
<table class="listtable">
<tr><td>1.</td><td>If <i>node.right</i> is not null, take <i>node.right</i>'s left children until
we reach a node with no left child.</td></tr>
<tr><td>2.</td><td>If <i>node.right</i> is null, follow the node up the tree until we move up a
left branch.</td></tr>
</table>
<br>
<p>We can illustrate these movements in the following diagram:</p>
<br>
<svg version="1.1" viewBox="0 0 1000 350" class="diagram">
<g transform="translate(150,10)">
	<rect x="0" y="0" width="700" height="330" stroke-width="1" fill="none"/>
	<line x1="350" y1="0" x2="350" y2="330" style="stroke-width:1"/>
	<line x1="0" y1="50" x2="700" y2="50" style="stroke-width:1"/>
	<line x1="0" y1="285" x2="700" y2="285" style="stroke-width:1"/>
	<g transform="translate(25,75)">
		<text x="139" y="-50" dy="0.3em" text-anchor="middle" style="font-size:150%">Case 1 - Down</text>
		<line x1="59" y1="79" x2="139" y2="19"/>
		<line x1="219" y1="79" x2="139" y2="19" stroke-width="4" class="highstroke"/>
		<line x1="19" y1="139" x2="59" y2="79"/>
		<line x1="99" y1="139" x2="59" y2="79"/>
		<line x1="179" y1="139" x2="219" y2="79" stroke-width="4" class="highstroke"/>
		<line x1="259" y1="139" x2="219" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="139" cy="19" r="17"/>
			<circle cx="59" cy="79" r="17"/>
			<circle cx="219" cy="79" r="17"/>
			<circle cx="19" cy="139" r="17"/>
			<circle cx="99" cy="139" r="17"/>
			<circle cx="179" cy="139" r="17"/>
			<circle cx="259" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="139" y="20" dy="0.3em">4</text>
			<text x="59" y="80" dy="0.3em">2</text>
			<text x="219" y="80" dy="0.3em">6</text>
			<text x="19" y="140" dy="0.3em">1</text>
			<text x="99" y="140" dy="0.3em">3</text>
			<text x="179" y="140" dy="0.3em">5</text>
			<text x="259" y="140" dy="0.3em">7</text>
			<text x="139" y="237">next(4) = 5</text>
		</g>
		<g style="font-size:80%">
			<text x="165" y="10" class="highfill">right is not null</text>
			<text x="165" y="10" dy="1.2em" class="highfill">go right</text>
			<text x="245" y="80" dy="0.3em" class="highfill">go left</text>
			<text x="170" y="175" class="highfill">left is null</text>
			<text x="170" y="175" dy="1.2em" class="highfill">return node 5</text>
		</g>
	</g>
	<g transform="translate(375,75)">
		<text x="139" y="-50" dy="0.3em" text-anchor="middle" style="font-size:150%">Case 2 - Up</text>
		<line x1="59" y1="79" x2="139" y2="19" stroke-width="4" class="highstroke"/>
		<line x1="219" y1="79" x2="139" y2="19"/>
		<line x1="19" y1="139" x2="59" y2="79"/>
		<line x1="99" y1="139" x2="59" y2="79" stroke-width="4" class="highstroke"/>
		<line x1="179" y1="139" x2="219" y2="79"/>
		<line x1="259" y1="139" x2="219" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="139" cy="19" r="17"/>
			<circle cx="59" cy="79" r="17"/>
			<circle cx="219" cy="79" r="17"/>
			<circle cx="19" cy="139" r="17"/>
			<circle cx="99" cy="139" r="17"/>
			<circle cx="179" cy="139" r="17"/>
			<circle cx="259" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="139" y="20" dy="0.3em">4</text>
			<text x="59" y="80" dy="0.3em">2</text>
			<text x="219" y="80" dy="0.3em">6</text>
			<text x="19" y="140" dy="0.3em">1</text>
			<text x="99" y="140" dy="0.3em">3</text>
			<text x="179" y="140" dy="0.3em">5</text>
			<text x="259" y="140" dy="0.3em">7</text>
			<text x="139" y="237">next(3) = 4</text>
		</g>
		<g style="font-size:80%">
			<text x="165" y="10" class="highfill">2 is left child</text>
			<text x="165" y="10" dy="1.2em" class="highfill">return node 4</text>
			<text x="85" y="80" class="highfill">3 is not left</text>
			<text x="85" y="80" dy="1.2em" class="highfill">child; go up</text>
			<text x="100" y="175" class="highfill">right is null</text>
			<text x="100" y="175" dy="1.2em" class="highfill">go up</text>
		</g>
	</g>
</g>
</svg>
<br>
<p>This procedure yields the following python function for <i>next()</i>:</p>
<br>
<div class="codeblock langpython">def next(node):
	ret=node.right
	if ret:
		child=ret.left
		while child: ret,child=child,ret.left
	else:
		ret,child=node.parent,node
		while ret and ret.right is child:
			ret,child=ret.parent,ret
	return ret</div>
<br>
<p>The <i>prev()</i> function is exactly the same as <i>next()</i>, except we swap all instances of <i>node.left</i> with
<i>node.right</i>:</p>
<br>
<div class="codeblock langpython">def prev(node):
	ret=node.left
	if ret:
		child=ret.right
		while child: ret,child=child,ret.right
	else:
		ret,child=node.parent,ret
		while ret and ret.left is child:
			ret,child=ret.parent,ret
	return ret</div>
<br>
<h2>Removing</h2>
<br>
<p>Removing a node involves replacing all links to the node with that of its successor, <i>next(node)</i>, and
then rebalancing. It would be simpler to swap the node's key/value pair with that of its successor,
and then remove the successor, but this would invalidate any external pointers a user might have to
the successor node. Indeed, a user might find it odd that the node that was supposed to be removed
still exists, and another node has been deallocated without warning.</p>
<br>
<p>There are 3 cases to consider when removing a node.</p>
<br>
<table class="listtable">
<tr><td>1.</td><td>The node has a null child.</td></tr>
<tr><td>2.</td><td>The successor is the right child of the node.</td></tr>
<tr><td>3.</td><td>The successor is a distant descendant of the node.</td></tr>
</table>
<br>
<p>If the node has a null child, then we simply replace the node with its other child and rebalance
from the node's parent upwards.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 370" class="diagram">
<g transform="translate(200,20)">
	<text x="300" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 1</text>
	<rect x="0" y="20" width="600" height="320" stroke-width="1" fill="none"/>
	<line x1="0" y1="280" x2="600" y2="280" style="stroke-width:1"/>
	<line x1="300" y1="20" x2="300" y2="280" style="stroke-width:1"/>
	<g transform="translate(290,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(290,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(75,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17" class="dimfill"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">5</text>
			<text x="59" y="140" dy="0.3em">4</text>
			<text x="19" y="200" dy="0.3em">2</text>
			<text x="99" y="200" dy="0.3em">3</text>
			<text x="70" y="270" dy="0.3em">remove node 5</text>
		</g>
		<g text-anchor="middle" style="font-size:80%">
			<text x="139" y="140" dy="0.3em">NUL</text>
		</g>
	</g>
	<g transform="translate(375,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">2</text>
			<text x="139" y="140" dy="0.3em">3</text>
			<text x="79" y="270" dy="0.3em">replace with node 4</text>
		</g>
	</g>
</g>
</svg>
<br>
<p>If neither child is null, then we know that the next node will be a child on the right-hand side of
the node. We also know that, by definition, the next node will have no left child. Thus, for case 2,
if the next node is the node's right child, then we can replace the node with the next node without
having to worry about shuffling around either nodes' children.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 370" class="diagram">
<g transform="translate(200,20)">
	<text x="300" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 2</text>
	<rect x="0" y="20" width="600" height="320" stroke-width="1" fill="none"/>
	<line x1="0" y1="280" x2="600" y2="280" style="stroke-width:1"/>
	<line x1="300" y1="20" x2="300" y2="280" style="stroke-width:1"/>
	<g transform="translate(290,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(290,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(50,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<line x1="99" y1="199" x2="139" y2="139"/>
		<line x1="179" y1="199" x2="139" y2="139"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17" class="dimfill"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
			<circle cx="99" cy="199" r="17"/>
			<circle cx="179" cy="199" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">3</text>
			<text x="59" y="140" dy="0.3em">2</text>
			<text x="139" y="140" dy="0.3em">4</text>
			<text x="179" y="200" dy="0.3em">5</text>
		</g>
		<g text-anchor="middle" style="font-size:80%">
			<text x="99" y="200" dy="0.3em">NUL</text>
		</g>
		<g transform="translate(40,265)">
			<text x="0" y="0">remove node 3</text>
			<text x="0" y="0" dy="1.2em">next(3) = 4</text>
		</g>
	</g>
	<g transform="translate(375,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">2</text>
			<text x="139" y="140" dy="0.3em">5</text>
		</g>
		<g transform="translate(-20,265)">
			<text x="0" y="0">node 4 is right child of</text>
			<text x="0" y="0" dy="1.2em">node 3; replace node 3</text>
		</g>
	</g>
</g>
</svg>
<br>
<p>For case 3, the next node will be a distant child of the node. So, we must first remove the next
node (as in case 1), and then replace the node with the next node.</p>
<br>
<svg version="1.1" viewBox="0 0 1000 370" class="diagram">
<g transform="translate(50,20)">
	<text x="450" y="0" text-anchor="middle" style="font-size:170%" dy="0.3em">Case 3</text>
	<rect x="0" y="20" width="900" height="320" stroke-width="1" fill="none"/>
	<line x1="0" y1="280" x2="900" y2="280" style="stroke-width:1"/>
	<line x1="300" y1="20" x2="300" y2="280" style="stroke-width:1"/>
	<line x1="600" y1="20" x2="600" y2="280" style="stroke-width:1"/>
	<g transform="translate(290,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(290,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(590,293)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(590,317)">
		<line x1="0" y1="7" x2="20" y2="7" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="0" style="stroke-width:1"/>
		<line x1="20" y1="7" x2="13" y2="14" style="stroke-width:1"/>
	</g>
	<g transform="translate(75,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<line x1="19" y1="199" x2="59" y2="139"/>
		<line x1="99" y1="199" x2="59" y2="139"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17" class="dimfill"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
			<circle cx="19" cy="199" r="17"/>
			<circle cx="99" cy="199" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">2</text>
			<text x="139" y="140" dy="0.3em">5</text>
			<text x="99" y="200" dy="0.3em">3</text>
		</g>
		<g text-anchor="middle" style="font-size:80%">
			<text x="19" y="200" dy="0.3em">NUL</text>
		</g>
		<g transform="translate(15,265)">
			<text x="0" y="0">remove node 1</text>
			<text x="0" y="0" dy="1.2em">next(1) = 2</text>
		</g>
	</g>
	<g transform="translate(375,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17" class="dimfill"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">1</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">3</text>
			<text x="139" y="140" dy="0.3em">5</text>
		</g>
		<g transform="translate(-35,265)">
			<text x="0" y="0">node 2 not right child</text>
			<text x="0" y="0" dy="1.2em">of node 1; remove node 2</text>
		</g>
	</g>
	<g transform="translate(675,40)">
		<line x1="19" y1="79" x2="59" y2="19"/>
		<line x1="99" y1="79" x2="59" y2="19"/>
		<line x1="59" y1="139" x2="99" y2="79"/>
		<line x1="139" y1="139" x2="99" y2="79"/>
		<g class="bgfill highstroke">
			<circle cx="59" cy="19" r="17"/>
			<circle cx="19" cy="79" r="17"/>
			<circle cx="99" cy="79" r="17"/>
			<circle cx="59" cy="139" r="17"/>
			<circle cx="139" cy="139" r="17"/>
		</g>
		<g text-anchor="middle">
			<text x="59" y="20" dy="0.3em">2</text>
			<text x="19" y="80" dy="0.3em">0</text>
			<text x="99" y="80" dy="0.3em">4</text>
			<text x="59" y="140" dy="0.3em">3</text>
			<text x="139" y="140" dy="0.3em">5</text>
		</g>
		<g transform="translate(10,265)">
			<text x="0" y="0">replace node 1</text>
			<text x="0" y="0" dy="1.2em">with node 2</text>
		</g>
	</g>
</g>
</svg>
<br>
<p>The complete python code for removing a given node is shown below.</p>
<br>
<div class="codeblock langpython">def removenode(tree,node):
	#Remove a specific node.
	def setchild(n,c):
		p=n.parent
		if p:
			if p.right is n: p.right=c
			else: p.left=c
		else: tree.root=c
		if c: c.parent=p
	#If the node has a null child, we can just replace the node with its other
	#child.
	bal=node.parent
	left,right=node.left,node.right
	if not right : next=left
	elif not left: next=right
	else:
		#Otherwise, properly remove the next node and place it in the node's spot.
		next=node.next()
		setchild(next,next.right)
		right=node.right
		left.parent=next
		if right: right.parent=next
		next.left=left
		next.right=right
		next.height=node.height
		bal=next.parent
		if bal is node: bal=next
	setchild(node,next)
	tree.rebalance(bal)</div>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Time Complexity ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Time Complexity</h1>
<p>The height of a binary search tree determines the time complexity of all of its operations. Thus, we
will first demonstrate the <i>O(log(n))</i> worst-case height of an AVL tree.</p>
<br>
<p>Let an AVL tree be a binary tree that satisfies <i>-1&lt;=right.height-left.height&lt;=1</i> for left and right
sibling nodes. Then, any AVL tree with <i>n</i> nodes will have height at most <i>h&lt;1.440*log2(n+1)</i>.</p>
<br>
<p>Proof: Let <i>m(h)</i> be the minimum number of nodes required for an AVL tree of height <i>h</i>. It can be seen
that <i>m(0)=1</i> and <i>m(1)=2</i>. Thus, for some <i>h&gt;=2</i>, let <i>T</i> be a tree with height <i>h</i> and <i>m(h)</i> nodes.
Furthermore, Let <i>L</i> and <i>R</i> be its left and right subtrees with heights <i>L.h</i> and <i>R.h</i>. Since
<i>h=max(L.h,R.h)+1</i>, either <i>L.h</i> or <i>R.h</i> must be <i>h-1</i>. Without loss of generality, assume <i>L.h=h-1</i>. Now, to
minimize the number of nodes in <i>R</i> and maintain AVL properties, let <i>R.h=h-2</i>. It follows that for <i>T</i> to
have the minimum number of nodes for height <i>h</i>, both <i>L</i> and <i>R</i> must have the minimum number of nodes in
their respective subtrees. Thus <i>L</i> must have <i>m(h-1)</i> nodes and <i>R</i> must have <i>m(h-2)</i>. Adding the root
node of <i>T</i> with the nodes in <i>L</i> and <i>R</i>, we obtain <i>m(h)=1+m(h-1)+m(h-2)</i> nodes in <i>T</i>.</p>
<br>
<p>To solve for the bound on <i>n=m(h)</i>, let <i>phi=(1+sqrt(5))/2</i>. We want to show <i>m(h)&gt;phi^h-1</i>.</p>
<br>
<div class="codeblock">m(0)=1&gt;phi^0-1=0
m(1)=2&gt;phi^1-1=0.62

m(h)=1+phi^(h-1)-1+phi^(h-2)-1
m(h)&gt;phi^(h-1)-1+phi^(h-2)-1+1
    =phi^(h-2)*(1+phi)-1
    =phi^(h-2)*phi^2-1           (since phi^2=1+phi)
    =phi^h-1
m(h)&gt;phi^h-1</div>
<br>
<p>To prove the bound on <i>h</i>, we solve for <i>h</i> in <i>n&gt;phi^h-1</i>.</p>
<br>
<div class="codeblock">n&gt;phi^h-1
h&lt;log2(n+1)/log2(phi)
h&lt;1.440*log2(n+1)</div>
<br>
<p>As desired.</p>
<br>
<p>References: <a href="https://courses.cs.washington.edu/courses/cse373/08sp/lectures/AVL-proof-and-code.pdf">Ruth Anderson's AVL Slides</a>.</p>
<br>
<h2>Operational Time Complexity</h2>
<br>
<p>Now, we can show that the worst-case time complexity for our operations is also <i>O(log(n))</i>.</p>
<br>
<p>Rebalancing only moves up the tree, which is <i>O(log(n))</i>, and performs 1 or 2 rotations per node,
which are <i>O(1)</i>. Thus rebalancing is <i>O(log(n))</i>.</p>
<br>
<p>Searching only moves down the tree, which is <i>O(log(n))</i>, and performs one comparison per node, which
is <i>O(1)</i>. Thus searching is <i>O(log(n))</i>.</p>
<br>
<p>Next/prev must either travel all the way up the tree or down the tree, which is <i>O(log(n))</i>. The
average number of operations per next/prev is 2.</p>
<br>
<p>Adding a node involves searching for a node's destined position, which is <i>O(log(n))</i>, and
rebalancing, which is <i>O(log(n))</i>. Thus adding nodes is <i>O(log(n))</i>.</p>
<br>
<p>Removing a node involves at most finding the node, which is <i>O(log(n))</i>, finding the next node, which
is <i>O(log(n))</i>, swapping, which is <i>O(1)</i>, and balancing, which is <i>O(log(n))</i>. Thus, removing a node is
<i>O(log(n))</i>.</p>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Notes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div class="content"><h1>Notes</h1>
<p>Our implementation of an AVL tree performs above average compared to other implementations found
online, but is far from the best. Peformance of the rebalancing and removal functions will need to
be improved to be competitive.</p>
<br>
<p><a href="https://en.wikipedia.org/wiki/B-tree">B-trees</a> are the predecessors to most self balancing trees. They are rarely used in practice,
however.</p>
<br>
<p>The article presents AVL trees as only using the absolute height of nodes. Although this is a more
sturdy method of maintaining node balance, it is actually faster to record the relative balance of
children nodes for each node. That is, instead of each node having a height attribute, they would
instead have a balance attribute that must be kept between -1 and +1.</p>
<br>
<p><a href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">Red-black trees</a> are the most popular alternative for self balancing trees. They require less
information per node, but have a more complicated rebalancing step. Also, even though their maximum
height is <i>h&lt;2*log2(n)</i>, their real-time performance is still competitive with AVL trees.</p>
<br>
<p>Concurrency has been a difficult problem for AVL trees. Most papers present AVL trees with a reduced
set of operations in order to make them concurrent. Researchers seem to have had better luck with
making Red-black trees concurrent.</p>
</div>

<!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Footer ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
<div id="footer">Created on 27 Apr 2018 - Modified on 4 Jul 2020<br>
Questions and comments: akdee<b>OBFUS</b>144@g<b>CATE</b>mail.com<br>
<a href="../index.html">Alec Dee's Homepage</a></div>
</body>
</html>
